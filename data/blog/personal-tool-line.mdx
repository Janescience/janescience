---
title: เมื่ออยากมี Tools ส่วนตัวใช้ในชีวิตประจำวันผ่าน LINE
date: "2023-05-30"
tags: ["node", "line", "android", "googlecloud"]
draft: true
summary: ""
layout: PostSimple
featureImage: "/static/images/blog/personal-tool-line/cover.png"
---

<center>![Cover](/static/images/blog/personal-tool-line/cover.png)</center>
<center className="text-xs">
  ขอบคุณรูปภาพจาก
  [https://bs-uploads.toptal.io](https://bs-uploads.toptal.io/blackfish-uploads/components/seo/content/og_image_file/og_image/1020542/chatbot-fails-b7e2373d46845ca189f736687c435770.png)
</center>

จุดเริ่มต้นทั้งหมดเริ่มจากผมได้ไปดู Video ของคุณ [dtinth](https://dt.in.th/) ชื่อ Video ว่า [Let’s build a personal assistant bot and level up your coding skills!](https://youtu.be/IdFX7nwD744)
เมื่อผมดูจนจบ ผมสนใจมากๆ(ค่อนข้างจะตื่นเต้นกับอะไรที่ไม่เคยทำ) และผมได้เริ่มทำมันทันที !!

## ทำอะไรไปบ้าง ?

<center>![Cover](/static/images/blog/personal-tool-line/maping.png)</center>

หลักๆแล้วแบ่งออกเป็น 2 Process

1. **LINE** - เป็นส่วนที่ให้ User ใช้งาน พูดคุยกับ Bot ชื่อว่า [Janalyze](#janalyze)
2. **Service** - เป็นส่วนของการทำงานฝั่งหลังบ้านที่จะรับข้อมูลจาก LINE แล้วเอามาประมวลผลตาม Logic ผมตั้งชื่อว่า [Jasistant](#jasistant)

<br />

<center>. . .</center>

<br />

### Janalyze

1. เข้าไปที่ [LINE Developers](https://developers.line.biz/en/) แล้ว Login จะเจอกับหน้านี้

![Cover](/static/images/blog/personal-tool-line/console.png)

<br />

2. สร้าง Providers (จากรูปข้อที่ 1 คลิก **"Create"**) ใส่ชื่ออะไรก็ได้

![Cover](/static/images/blog/personal-tool-line/create-pro.png)

<br />

3. เลือก **"Create a Messaging API channel"**

![Cover](/static/images/blog/personal-tool-line/choose.png)

<br />

4. กรอกข้อมูลต่างๆให้ครบ แล้ว **"Create"**

![Cover](/static/images/blog/personal-tool-line/channel-create.png)

<br />

5. มาที่ **"Messaging API"** แล้วเลื่อนลงไปที่ **"Webhook settings"** ทำการแก้ไข **"Webhook URL"**
   ต้องเป็น HTTPS เท่านั้น เมื่อส่งข้อความหา Bot จะมาเรียก URL ที่เรากรอกไปเสมอ

![Cover](/static/images/blog/personal-tool-line/webhook-url.png)

<br />

6. สามารถ Scan QR Code เพิ่มเพื่อน Bot ได้เลย

![Cover](/static/images/blog/personal-tool-line/qr.png)

<br />

<center>. . .</center>

<br />

### Jasistant

ตอนเริ่มแรกผมยังไม่มี URL ที่เป็น HTTPS และผมอยากรีบทดสอบแบบเร็วๆ ผมเลยไปใช้ [Glitch](https://glitch.com/)
เป็น IDE บน Browser สามารถเอา URL ขวาบนมาใช้ได้เลย แต่สำหรับเริ่มต้นเท่านั้นนะ ควรเอามาขึ้น Github แล้วหา Host ให้มันอยู่ดีๆ

![Cover](/static/images/blog/personal-tool-line/glitch.png)

*จากรูปเราแค่ใส่ Log อะไปก็ได้ใน `/webhook` แล้วลองส่งข้อความหา Bot*

พอผมเริ่มเข้าใจและวางโครงได้แล้ว เลยมาทำเป็น Custom Service และหา Host ให้มันอยู่ โดยมี Tech Stack ประมาณนี้

**Language** - [Node.js](https://nodejs.org/en)

**Framework** - [Express.js](https://expressjs.com/)

**Host** - [Vercel](https://vercel.com/)

**Storage** - [Google Cloud Storage](https://cloud.google.com/storage) (เก็บรูปภาพ)

**AI** - [Google Cloud Vision AI](https://cloud.google.com/vision) (ดึงข้อความจากรูปภาพ)

**Database** - [Airtable](https://www.airtable.com/) (บันทักรายจ่าย)

**NPM Package**

- [promptpay-qr](https://github.com/dtinth/promptpay-qr) (สร้าง QR Code แบบพร้อมเพย์)
- [tweetnacl-sealedbox-js](https://www.npmjs.com/package/tweetnacl-sealedbox-js) (ส่งหรือรับข้อมูลแบบเข้ารหัส)

<br />

<center>. . .</center>

<br />

### Structure

```
└──src
│   └── config
│   │   └── line.config.js
│   └── controllers
│   │   └── notification.controller.js
│   └── middlewares
│   │   ├── error-handler.js
│   │   └── log-event.js
│   └── modules
│   │   └── expense-tracking.module.js
│   │   └── qrcode-promptpay.module.js
│   └── routes
│   │   ├── webhook.routes.js
│   └── services
│   │   └── image.service.js
│   │   └── message.service.js
│   └── utilities
│       └── line.utility.js
│       └── storage.utility.js
└──views
│   └── 404.html
│   └── index.html
└──.env
└──server.js
└──vercel.json
```

<br />

<center>. . .</center>

<br />

### Server properties

```js:server.js
// Import NPM
const express = require('express');
const bodyParser = require('body-parser')
const path = require("path");
const errorHandler  = require('./src/middlewares/error-handler');
const dotenv = require('dotenv');
dotenv.config();

// Initialize Express App 
const app = express();
app.use(express.json({limit:'50mb'}))
app.use(express.urlencoded({limit: '50mb', extended:true }))
app.use(express.static(path.join(__dirname, '/public')))
app.use(bodyParser.text())

// Routes Setup  
require('./src/routes/webhook.routes')(app);

// Basic Route
app.get(["/","/index.html"],(req,res) => {
  res.sendFile(path.join(__dirname, 'views','index.html'));
})

// Not Found Route
app.all("*", (req,res) => {
  res.status(404);
  if(req.accepts('html')){
    res.sendFile(path.join(__dirname, 'views','404.html'));
  } else if (req.accepts('json')) {
    res.json({error : "404 Not Found"});
  }else {
    res.type('txt').send('404 Not Found')
  }
})

//Error Handler
app.use(errorHandler)

//App Started
app.listen(process.env.PORT, () => {
  console.log("Server is running on port : ",process.env.PORT);
})
```

#### Comments

- ***Import NPM*** - เป็นส่วนที่บอกว่า Code หน้านี้เราจะใช้ NPM อะไรบ้าง ก็ให้ Import เข้ามาและเราต้อง Install ผ่าน `npm` ก่อนด้วย
  ```bash
  npm i express body-parser dotenv
  ```
- ***Initialize Express App*** - เรียกใช้เฟรมเวิร์ค Express และตั้งค่าต่างๆ ไม่ว่าจะเป็น Limit การรับส่งข้อมูล หรือ Path ของ Static file
- ***Routes Setup*** - บอกว่า App มี Routes อะไรบ้าง โดยในไฟล์จะเป็นการกำหนด HTTP Method แยก Path ตามไฟล์ เมื่อเรียก URL มาที่ `/webhook` จะวิ่งเข้า `webhook.controller`
  ```js:webhook.routes.js
  const controller = require("../controllers/webhook.controller");
  const { logger } = require("../middlewares/log-events");
  module.exports = function(app) {
    app.use(function(req, res, next) {
      res.header(
        "Access-Control-Allow-Headers",
        "x-access-token, Origin, Content-Type, Accept"
      );
      next();
    });

    app.post('/webhook',[logger],controller.webhook);
  };
  ```
  
- ***Basic Route*** - กำหนด Default Path ถ้าเข้าด้วย URL `/` หรือ `/index.html` จะให้ทำอะไรบ้างหรือ Redirect ไปไฟล์ไหน 
  ```html:index.html
  <div id="main">
    <div class="fof">
        <h1>Welcome Jasistant Engine</h1>
    </div>
  </div>
  ```
- ***Not Found Route*** - กำหนดว่าถ้ามีการเข้า URL อะไรก็ตามที่ไม่มีอยู่ใน App จะให้แสดงเป็นอะไร ของผมให้แสดงหน้า `404.html`
  ```html:404.html
  <div id="main">
    <div class="fof">
        <h1>Error 404</h1>
    </div>
  </div>
  ```
- ***Error Handler*** - เมื่อมี Error จะให้ทำตาม Process ในไฟล์ `/src/middlewares/error-handler`
  ```js:error-handler.js
  const { logEvents } = require('./log-events');

  const errorHandler = (err,req,res,next) => {
      logEvents(`${err.name} : ${err.message}`);
      res.status(500).send(err);
  }

  module.exports = errorHandler;
  ```
  - **errorHandler** - ทุกครั้งที่เกิด Error จะให้แสดง Log ออกมาผ่าน `logEvent` และ Return กลับไปด้วย Error code = 500 เสมอ
  ```js:log-event.js
  const { format } = require('date-fns');
  const { v4:uuid } = require('uuid');

  const logEvents = async (message) => {
      const dateTime = `${format(new Date(),'yyyyMMdd\tHH:mm:ss')}`;
      const logItem = `${dateTime}\t${uuid()}\t${message}\n`;
      console.log(logItem)
  }

  const logger = (req,res,next) => {
      if(req.body){
          console.log(`${req.method} ${req.path} ${JSON.stringify(req.body)}`);
      }else{
          console.log(`${req.method} ${req.path}`);
      }
      next();
  }

  module.exports = { logger , logEvents};
  ```
  - **logEvents** - ที่เราทำแบบนี้เพื่อกำหนด Format ของ Log และเลือกได้จะเรียกใช้ตรงไหน
  - **logger** - สำหรับเอาไว้ Log ทุกครั้งที่มีการ Request เข้ามา และเราเลือกจะใส่หรือไม่ใส่ก็ได้แต่ล่ะ Path ในไฟล์ `.routes.js`
- ***App Started*** - กำหนดได้ว่าให้ Running ที่ PORT อะไร ผมกำหนดไว้ใน `process.env.PORT` 
และในฟังก์ชัน `listen` กำหนดได้ว่าให้ทำอะไรบ้างตอน Start project ผมให้แสดง Log ออกมาว่า Run ที่ PORT อะไร
  ```js:.env
  PORT=3000
  ```
---

## การใช้งาน

1. **Expense Record** - แน่นอนว่าทุกวันนี้มีแอปบันทึกรายรับ-รายจ่ายเต็มไปหมด แต่การบันทึกแต่ล่ะรายการนั้น
   ต้องทำอย่างน้อย 2-3 step และมีหลายอย่างที่ต้องกรอก แต่ Line Bot ของผมแค่พิมพ์สั้นๆ เช่น พิมพ์ว่า "60f" เป็นการบอกว่า จ่ายค่าอาหารไป 60 บาทนะ
   และ Bot จะตอบกลับมาโดยสามารถคลิกเข้าไปแก้ไขข้อมูลได้ผ่าน [Airtable](https://www.airtable.com/)

| คำสั่ง "60f"                                           | คำสั่ง "145d startbuck"                                  |
| ------------------------------------------------------ | -------------------------------------------------------- |
| ![60f](/static/images/blog/personal-tool-line/60f.jpg) | ![145d](/static/images/blog/personal-tool-line/145d.jpg) |

| Airtable(Rows)                                                        | Airtable(Detail)                                                          |
| --------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| ![Airtable Rows](/static/images/blog/personal-tool-line/airtable.jpg) | ![Airtable Detail](/static/images/blog/personal-tool-line/air-detail.jpg) |

<br />

<center>. . .</center>

<br />

2. **QR Code Promptpay** - ทำได้ง่ายๆ ถ้าอยากได้ QR ที่เป็น 100 บาท ก็พิมพ์ว่า "qr100" ก็จะได้ QR Code ที่ล็อคจำนวนเงินไว้ให้เลย (ลอง Scan ดูได้)
   การทำงานคร่าวๆ คือสร้าง QR Code เป็น Buffer แล้ว Upload ขึ้น Google Cloud Storage ส่งค่ากลับมาเป็น Url และ Reply กลับมาผ่าน Line แสดงเป็นรูปภาพ

![QR Code](/static/images/blog/personal-tool-line/qrcode.png)

<br />

<center>. . .</center>

<br />

3. **Image to Text** - ส่งรูปภาพอะไรไปก็ได้ แล้ว Bot จะตอบกลับมาเป็นข้อความทั้งหมดที่อยู่ในรูปภาพ ความแม่นยำและถูกต้องขึ้นอยู่กับความคมชัดของข้อความในรูปภาพ แต่ถ้าเป็นภาษาไทยประโยคที่ได้จะเว้นเป็นคำๆ
   ไม่ติดกัน ซึ่งผมก็ไม่ทราบว่าเพราะอะไร เพราะการดึงข้อความตรงนี้เราใช้ [Google Cloud Vision AI](https://cloud.google.com/vision)

![QR Code](/static/images/blog/personal-tool-line/imgtotxt1.png)

ซึ่งถ้าเขียนด้วยลายมือ Bot อาจจะอ่านไม่ออกบางคำ จะเห็นตกคำว่า **"เค้าแค่ไม่อยาก"** และคำว่า **"งดรีโพส"** ได้มาเป็น **"งด รีม ส"**

![QR Code](/static/images/blog/personal-tool-line/imgtotxt2.png)

แต่ถ้าเป็นตัวอักษรที่พิมพ์เอาและถ่ายให้ชัดเจน ค่อนข้างจะถูกต้อง 100% นอกจากตัวอักษรนั้นจะเล็กมากๆ
