---
title: Authentication ด้วย Spring Security & JWT & Docker
date: "2023-02-28"
tags: ["java"]
draft: false
summary: ""
layout: PostSimple
featureImage: "/static/images/blog/auth-springboot-jwt/cover.png"
---

<center>![Auth API Spring Boot](/static/images/blog/auth-springboot-jwt/cover.png)</center>*<center className="text-xs">
  ขอบคุณรูปภาพจาก
  [https://nullpointerexception.pl](https://nullpointerexception.pl/wp-content/uploads/2019/10/springsecurity-jwt.png){" "}
</center>*

> แนะนำสำหรับคนที่เคยเขียนหรือเข้าใจ Spring Boot มาบ้างแล้ว

ก่อนจะเริ่มเรามาทำความเข้าใจกันก่อนว่า ในบทความนี้ผมจะไม่ได้อธิบายเกี่ยวกับ JWT มากนัก
และถ้ายังไม่รู้จักหรือเข้าใจ JWT ผมแนะนำให้ไปอ่านบทความของ [Chainarong Tangsurakit](https://medium.com/rootusercc/json-web-token-มาตรฐานใหม่-ในการทำ-authentication-b0760dd9acd1)
เค้าเขียนอธิบายไว้ค่อนข้างละเอียดและเห็นภาพชัดเจนตั้งแต่ปี 2016

ส่วน Docker เราเสริมเข้ามาเพื่อให้ง่ายสำหรับการต่อ Database สามารถ Clone แล้ว Run ได้เลยที่ Environment ไหนก็ได้เพียงแค่มี Docker
(ไม่อย่างงั้นต้องติดตั้ง Postgres service ในเครื่องก่อนเพื่อให้สามารถต่อ localhost:5432 ได้ ซึ่งยุ่งยากกว่า เชื่อผมเหอะ)

## Technology

- Java 19
- Spring Boot 3
  - Spring Security
  - Spring Web
  - Spring Data JPA
- Swagger UI
- jjwt 0.9.1
- PostgresSQL
- Maven 3.8.2
- Docker
  - Docker Compose

## Setup

### Spring Boot

เข้าเว็บ [Spring Boot](https://start.spring.io/#!type=maven-project&language=java&platformVersion=3.0.3&packaging=jar&jvmVersion=19&groupId=com.demo&artifactId=auth&name=auth&description=Demo%20project%20for%20Spring%20Security%20%26%20JWT%20%26%20Docker&packageName=com.demo.auth&dependencies=web,lombok,security,data-jpa,postgresql)
เพื่อสร้าง Spring boot project starter และ Dependencies ที่ผมใช้ตามรูปเลย

![Spring Init](/static/images/blog/auth-springboot-jwt/spring-init.png)

หลังจาก Download project มาแล้วลอง Run ดูจะพบว่ามี Error แบบนี้

```bash
***************************
APPLICATION FAILED TO START
***************************

Description:

Failed to configure a DataSource: 'url' attribute is not specified and no embedded datasource could be configured.

Reason: Failed to determine a suitable driver class


Action:

Consider the following:
        If you want an embedded database (H2, HSQL or Derby), please put it on the classpath.
        If you have database settings to be loaded from a particular profile you may need to activate it (no profiles are currently active).
```

เพราะมันถามหา Datasource และเรายังไม่ได้กำหนดให้มันใน application.properties

### Docker

เราจะใช้ [Docker](https://www.docker.com/) เป็น Local server และ Database โดยจะใช้ Docker compose

    สร้างไฟล์ docker compose

      ```yml:docker-compose.yml
      version: '3'

      services:
        app:
          image: api_backend:latest
          container_name: app
          depends_on:
            - db
          environment:
            - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/postgres
            - SPRING_DATASOURCE_USERNAME=postgres
            - SPRING_DATASOURCE_PASSWORD=p@stgres
            - SPRING_JPA_HIBERNATE_DDL_AUTO=update
          ports:
            - 8008:8080
        db:
          image: postgres:10.4
          container_name: db
          volumes:
                - /var/db/data/postgresql:/var/lib/postgresql
          environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=p@stgres
          ports:
            - 5432:5432
      ```

    > เราจะสร้าง 2 Container เป็น app และ db

    สร้างไฟล์ Shell script สำหรับ Run ชุดคำสั่ง Docker

      ```bash:build.sh
      docker rm -f app db
      docker build -t api_backend .
      docker-compose up
      ```

    สร้าง Dockerfile และเปลี่ยน [app-name] เป็นชื่อที่ต้องการ

    ```docker:Dockerfile
    FROM openjdk:8-jdk
    EXPOSE 8080
    RUN export LC_ALL=en_US.UTF-8
    RUN export LANG=en_US.UTF-8
    RUN export LC_TIME=th_TH.UTF-8
    RUN apt-get clean && apt-get -y update && apt-get install -y locales && locale-gen en_US.UTF-8 && locale-gen th_TH.UTF-8
    RUN locale-gen en_US.UTF-8
    ENV TZ=Asia/Bangkok
    RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    ARG JAR_FILE=build/[app-name]-0.0.1-SNAPSHOT.jar
    COPY ${JAR_FILE} [app-name].jar
    ENTRYPOINT ["java","-jar","-Dserver.port=8080","/[app-name].jar"]
    ```

    Runn wsl --update ใน cmd
    Run `./build.sh` ต้อง Start Docker(เข้า Desktop App) ก่อน

3. [Java 19](https://www.oracle.com/java/technologies/javase/jdk19-archive-downloads.html)
