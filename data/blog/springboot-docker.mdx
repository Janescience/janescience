---
title: Spring Boot & Docker
date: '2023-03-12'
tags: ['docker','springboot']
draft: true
summary: ''
layout: PostSimple
---

ส่วน Docker เราเสริมเข้ามาเพื่อให้ง่ายสำหรับการต่อ Database สามารถ Clone แล้ว Run ได้เลยที่ Environment ไหนก็ได้เพียงแค่มี Docker
(ไม่อย่างงั้นต้องติดตั้ง Postgres service ในเครื่องก่อนเพื่อให้สามารถต่อ `localhost:5432` ได้ ซึ่งยุ่งยากกว่า เชื่อผมเหอะ)

### [Docker](https://www.docker.com/) 

ใช้เป็น Local server และ Local database โดยจะใช้ [Docker Compose](https://medium.com/touch-technologies/ทำความรู้จัก-docker-compose-b6688fc98c6f)

    สร้างไฟล์สำหรับ Docker Compose

      ```yml:docker-compose.yml
      version: '3'

      services:
        app:
          image: api_backend:latest
          container_name: app
          depends_on:
            - db
          environment:
            - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/postgres
            - SPRING_DATASOURCE_USERNAME=postgres
            - SPRING_DATASOURCE_PASSWORD=p@stgres
            - SPRING_JPA_HIBERNATE_DDL_AUTO=update
          ports:
            - 8008:8080
        db:
          image: postgres:10.4
          container_name: db
          volumes:
                - /var/db/data/postgresql:/var/lib/postgresql
          environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=p@stgres
          ports:
            - 5432:5432
      ```

    > เราจะสร้าง 2 Container เป็น app และ db

<br/>

    สร้างไฟล์ Shell script สำหรับ Run ชุดคำสั่ง Docker

      ```bash:build.sh
      #Pack file .jar with mvn
      mvn clean compile package -Dmaven.test.skip=true
      #สร้าง Folder build
      mkdir build
      #ย้าย .jar ไปยัง build/
      mv target/auth-0.0.1-SNAPSHOT.jar build/
      docker rm -f app db
      docker build -t api_backend .
      docker-compose up
      ```

<br/>

    สร้าง Dockerfile และเปลี่ยน [app-name] ตาม `<name>...</name>` ใน `pom.xml`
    ตอนนี้ Hub ของ Docker openjdk ล่าสุดแค่ 18

    ```docker:Dockerfile
    FROM openjdk:18-jdk
    EXPOSE 8080
    RUN export LC_ALL=en_US.UTF-8
    RUN export LANG=en_US.UTF-8
    RUN export LC_TIME=th_TH.UTF-8
    RUN apt-get clean && apt-get -y update && apt-get install -y locales && locale-gen en_US.UTF-8 && locale-gen th_TH.UTF-8
    RUN locale-gen en_US.UTF-8
    ENV TZ=Asia/Bangkok
    RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    ARG JAR_FILE=build/[app-name]-0.0.1-SNAPSHOT.jar
    COPY ${JAR_FILE} [app-name].jar
    ENTRYPOINT ["java","-jar","-Dserver.port=8080","/[app-name].jar"]
    ```

    Run `./build.sh` (ต้อง Start Docker ก่อน) ถ้าสำเร็จ
        
        - จะเห็น Logs ของ app,db 
        - สามารถเข้า http://localhost:8008 ได้
        - ดู Containers ใน Docker desktop app จะเห็นว่า Run อยู่
        - เชื่อมต่อ DB ผ่าน DB Client ด้วย Config ตาม docker-compose.yml ต้องเชื่อมต่อได้

--- 